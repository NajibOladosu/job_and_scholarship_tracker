{% extends 'base.html' %}
{% load static %}

{% block title %}{{ application.title }} - AppTracker{% endblock %}

{% block content %}
<div class="container-fluid px-4 fade-in">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}" class="text-decoration-none"><i class="bi bi-house-door me-1"></i>Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ application.title }}</li>
        </ol>
    </nav>

    <!-- Application Header Card -->
    <div class="card mb-4">
        <div class="card-body p-4">
            <div class="row align-items-start g-4">
                <div class="col-lg-8">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-grow-1">
                            <h1 class="h2 fw-bold mb-3" style="color: var(--text-primary);">{{ application.title }}</h1>
                            <h5 class="mb-3" style="color: var(--text-secondary); font-weight: 500;">
                                <i class="bi bi-building me-2"></i>
                                {{ application.company_or_institution }}
                            </h5>
                        </div>
                        <div class="ms-3">
                            {% if application.status == 'draft' %}
                                <span class="badge" style="background: var(--color-gray-600); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'submitted' %}
                                <span class="badge" style="background: var(--color-info); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'in_review' %}
                                <span class="badge" style="background: var(--color-warning); color: var(--text-primary); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'interview' %}
                                <span class="badge" style="background: var(--color-primary); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'offer' %}
                                <span class="badge" style="background: var(--color-success); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'rejected' %}
                                <span class="badge" style="background: var(--color-danger); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% elif application.status == 'withdrawn' %}
                                <span class="badge" style="background: var(--color-gray-800); padding: 0.5rem 1rem; font-size: 0.875rem;">{{ application.get_status_display }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Metadata Stats -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--color-gray-50);">
                                <div class="me-3" style="width: 40px; height: 40px; background: var(--color-primary-gradient); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-tag-fill text-white fs-5"></i>
                                </div>
                                <div>
                                    <small class="d-block mb-1" style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Type</small>
                                    <span class="fw-bold" style="color: var(--text-primary);">{{ application.get_application_type_display }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--color-gray-50);">
                                <div class="me-3" style="width: 40px; height: 40px; background: {% if application.priority == 'high' %}var(--color-danger){% elif application.priority == 'medium' %}var(--color-warning){% else %}var(--color-success){% endif %}; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-flag-fill text-white fs-5"></i>
                                </div>
                                <div>
                                    <small class="d-block mb-1" style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Priority</small>
                                    <span class="fw-bold" style="color: {% if application.priority == 'high' %}var(--color-danger){% elif application.priority == 'medium' %}var(--color-warning){% else %}var(--color-success){% endif %};">
                                        {{ application.get_priority_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center p-3 rounded" style="background: var(--color-gray-50);">
                                <div class="me-3" style="width: 40px; height: 40px; background: var(--color-info); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-calendar-event-fill text-white fs-5"></i>
                                </div>
                                <div>
                                    <small class="d-block mb-1" style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Deadline</small>
                                    <span class="fw-bold" style="color: var(--text-primary);">
                                        {% if application.deadline %}
                                            {{ application.deadline|date:"M d, Y" }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    {% if application.is_overdue %}
                                        <span class="badge ms-2" style="background: var(--color-danger); font-size: 0.65rem;">Overdue</span>
                                    {% elif application.days_until_deadline is not None and application.days_until_deadline <= 7 %}
                                        <span class="badge ms-2" style="background: var(--color-warning); color: var(--text-primary); font-size: 0.65rem;">{{ application.days_until_deadline }}d left</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if application.url %}
                    <div class="mb-2">
                        <a href="{{ application.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>
                            View Application Posting
                        </a>
                    </div>
                    {% endif %}
                    </div>

                <!-- Action Buttons -->
                <div class="col-lg-4">
                    <div class="d-grid gap-2">
                        <a href="{% url 'tracker:application_edit' application.pk %}" class="btn btn-primary">
                            <i class="bi bi-pencil-fill me-2"></i>
                            Edit Application
                        </a>
                        <a href="{% url 'tracker:add_question' application.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle-fill me-2"></i>
                            Add Question
                        </a>
                        {% if application.questions.exists %}
                        <form method="post" action="{% url 'tracker:generate_responses' application.pk %}" class="m-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-stars me-2"></i>
                                Generate AI Responses
                            </button>
                        </form>
                        <form method="post" action="{% url 'tracker:generate_responses' application.pk %}" class="m-0">
                            {% csrf_token %}
                            <input type="hidden" name="regenerate" value="true">
                            <button type="submit" class="btn btn-warning w-100"
                                    onclick="return confirm('This will regenerate ALL responses, replacing existing ones. Continue?');">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Regenerate All Responses
                            </button>
                        </form>
                        {% endif %}
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash-fill me-2"></i>
                            Delete Application
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Description Section -->
    {% if application.description %}
    <div class="card mb-4">
        <div class="card-header" style="background: var(--color-gray-50); border-bottom: 2px solid var(--color-gray-200);">
            <h5 class="fw-bold mb-0" style="color: var(--text-primary);">
                <i class="bi bi-file-text-fill me-2" style="color: var(--color-primary);"></i>
                Description
            </h5>
        </div>
        <div class="card-body">
            <p class="mb-0" style="white-space: pre-wrap; color: var(--text-secondary); line-height: 1.7;">{{ application.description }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Tab Navigation -->
    <ul class="nav nav-pills mb-4" id="applicationTabs" role="tablist" style="background: var(--bg-card); padding: 0.5rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-sm);">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="questions-tab" data-bs-toggle="pill" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="true">
                <i class="bi bi-question-circle-fill me-2"></i>
                Questions & Responses
                <span class="badge ms-2" style="background: var(--color-primary);">{{ application.questions.count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="timeline-tab" data-bs-toggle="pill" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="false">
                <i class="bi bi-clock-history me-2"></i>
                Timeline
            </button>
        </li>
        {% if application.notes %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="pill" data-bs-target="#notes" type="button" role="tab" aria-controls="notes" aria-selected="false">
                <i class="bi bi-sticky-fill me-2"></i>
                Notes
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="applicationTabsContent">
        <!-- Questions & Responses Tab -->
        <div class="tab-pane fade show active" id="questions" role="tabpanel" aria-labelledby="questions-tab">
            <div class="card">
                <div class="card-body">
                    {% if application.questions.exists %}
                        <div class="accordion accordion-flush" id="questionsAccordion">
                            {% for question in application.questions.all %}
                            <div class="accordion-item mb-3" style="border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); overflow: hidden;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#question{{ question.pk }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="question{{ question.pk }}" style="background: var(--color-gray-50); font-weight: 600;">
                                        <span class="badge me-2" style="background: var(--color-primary);">Q{{ forloop.counter }}</span>
                                        <span class="flex-grow-1">{{ question.question_text|truncatewords:15 }}</span>
                                        {% if question.is_required %}
                                            <span class="badge ms-2" style="background: var(--color-danger); font-size: 0.7rem;">Required</span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="question{{ question.pk }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#questionsAccordion">
                                    <div class="accordion-body p-4">
                                        <!-- Question Details -->
                                        <div class="mb-4 pb-3" style="border-bottom: 1px solid var(--color-gray-200);">
                                            <h6 class="fw-bold mb-2" style="color: var(--text-primary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Question:</h6>
                                            <p class="mb-3" style="white-space: pre-wrap; color: var(--text-primary); line-height: 1.6; font-size: 0.95rem;">{{ question.question_text }}</p>
                                            <div class="d-flex gap-2 flex-wrap">
                                                <span class="badge" style="background: var(--color-info);">{{ question.get_question_type_display }}</span>
                                                {% if question.is_extracted %}
                                                    <span class="badge" style="background: var(--color-secondary);">
                                                        <i class="bi bi-robot"></i> Auto-extracted
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Response -->
                                        {% if question.response %}
                                            <div class="pt-3">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="fw-bold mb-0" style="color: var(--text-primary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                        Response:
                                                        {% if question.response.is_ai_generated %}
                                                            <span class="badge ms-2" style="background: var(--color-success);">
                                                                <i class="bi bi-stars"></i> AI Generated
                                                            </span>
                                                        {% endif %}
                                                    </h6>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('response-{{ question.pk }}', this)">
                                                        <i class="bi bi-clipboard me-1"></i>
                                                        Copy
                                                    </button>
                                                </div>
                                                <div id="response-{{ question.pk }}" class="p-4 rounded mb-3" style="background: var(--color-gray-50); white-space: pre-wrap; color: var(--text-primary); line-height: 1.7; font-size: 0.95rem; border-left: 4px solid var(--color-primary);">{{ question.response.final_response }}</div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small style="color: var(--text-muted);">
                                                        <i class="bi bi-clock me-1"></i>
                                                        Generated: {{ question.response.generated_at|date:"M d, Y g:i A" }}
                                                        {% if question.response.last_edited_at %}
                                                            | Edited: {{ question.response.last_edited_at|date:"M d, Y g:i A" }}
                                                        {% endif %}
                                                    </small>
                                                    <div>
                                                        <a href="{% url 'tracker:edit_response' question.pk %}" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-pencil-fill me-1"></i>
                                                            Edit
                                                        </a>
                                                        <form method="post" action="{% url 'tracker:regenerate_response' question.pk %}" class="d-inline">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                                <i class="bi bi-arrow-clockwise me-1"></i>
                                                                Regenerate
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="pt-3">
                                                <div class="alert mb-0" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: none; border-left: 4px solid var(--color-warning);" role="alert">
                                                    <i class="bi bi-exclamation-triangle-fill me-2" style="color: var(--color-warning);"></i>
                                                    <strong>No response yet.</strong> Generate AI responses or add manually.
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4" style="width: 80px; height: 80px; margin: 0 auto; background: var(--color-gray-100); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-question-circle" style="font-size: 2.5rem; color: var(--color-gray-400);"></i>
                            </div>
                            <h5 class="mb-2" style="color: var(--text-primary);">No Questions Yet</h5>
                            <p class="mb-4" style="color: var(--text-muted);">Add questions manually or extract them from the application URL.</p>
                            <a href="{% url 'tracker:add_question' application.pk %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle-fill me-2"></i>
                                Add First Question
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
            <div class="card">
                <div class="card-body">
                    {% if application.status_history.exists %}
                        <div class="timeline position-relative" style="padding-left: 2rem;">
                            {% for status in application.status_history.all %}
                            <div class="timeline-item d-flex mb-4 position-relative {% if forloop.last %}pb-0{% endif %}">
                                <div class="timeline-marker position-absolute" style="left: -2rem;">
                                    <div class="rounded-circle" style="width: 16px; height: 16px; background: var(--color-primary); border: 3px solid var(--bg-card); box-shadow: 0 0 0 3px var(--color-primary-light);"></div>
                                    {% if not forloop.last %}
                                        <div class="position-absolute" style="width: 2px; height: calc(100% + 1rem); left: 7px; top: 20px; background: var(--color-gray-300);"></div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-2">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="fw-bold mb-0" style="color: var(--text-primary);">{{ status.get_status_display }}</h6>
                                        <small style="color: var(--text-muted);">{{ status.created_at|date:"M d, Y g:i A" }}</small>
                                    </div>
                                    <small style="color: var(--text-muted);">
                                        <i class="bi bi-person-circle me-1"></i>
                                        {{ status.get_changed_by_display }}
                                    </small>
                                    {% if status.notes %}
                                        <p class="mt-2 mb-0 p-3 rounded" style="background: var(--color-gray-50); color: var(--text-secondary); font-size: 0.875rem;">{{ status.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-4" style="width: 80px; height: 80px; margin: 0 auto; background: var(--color-gray-100); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-clock-history" style="font-size: 2.5rem; color: var(--color-gray-400);"></i>
                            </div>
                            <h5 class="mb-2" style="color: var(--text-primary);">No Status History</h5>
                            <p class="mb-0" style="color: var(--text-muted);">Status changes will appear here as you update the application.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        {% if application.notes %}
        <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
            <div class="card">
                <div class="card-body p-4">
                    <div class="p-4 rounded" style="background: var(--color-gray-50); border-left: 4px solid var(--color-accent);">
                        <p class="mb-0" style="white-space: pre-wrap; color: var(--text-primary); line-height: 1.7;">{{ application.notes }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: var(--radius-xl); box-shadow: var(--shadow-2xl);">
            <div class="modal-header" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: none; border-top-left-radius: var(--radius-xl); border-top-right-radius: var(--radius-xl);">
                <h5 class="modal-title fw-bold" id="deleteModalLabel" style="color: var(--color-danger);">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-0" style="color: var(--text-primary); line-height: 1.6;">Are you sure you want to delete <strong>{{ application.title }}</strong>? This action cannot be undone and will remove all associated questions and responses.</p>
            </div>
            <div class="modal-footer" style="border: none; background: var(--color-gray-50);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel
                </button>
                <form method="post" action="{% url 'tracker:application_delete' application.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash-fill me-1"></i>
                        Delete Application
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Tab styling */
.nav-pills .nav-link {
    border-radius: var(--radius-lg);
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
}

.nav-pills .nav-link:hover {
    background: var(--color-gray-100);
    color: var(--text-primary);
}

.nav-pills .nav-link.active {
    background: var(--color-primary-gradient);
    color: var(--text-white);
    box-shadow: var(--shadow-md);
}

/* Accordion styling */
.accordion-button:not(.collapsed) {
    background: var(--color-gray-50);
    color: var(--text-primary);
    box-shadow: none;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: var(--color-gray-200);
}

.accordion-button::after {
    filter: brightness(0.6);
}

/* Animation for copy button */
@keyframes copySuccess {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.copy-success {
    animation: copySuccess 0.3s ease;
}
</style>

<script>
// Copy to clipboard functionality
function copyToClipboard(elementId, button) {
    const element = document.getElementById(elementId);
    const text = element.textContent;

    // Use modern Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            // Success feedback
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Copied!';
            button.classList.add('btn-success', 'copy-success');
            button.classList.remove('btn-outline-primary');

            // Reset after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success', 'copy-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text. Please try selecting and copying manually.');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();

        try {
            document.execCommand('copy');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Copied!';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary');

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
        } catch (err) {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy text. Please try selecting and copying manually.');
        }

        document.body.removeChild(textArea);
    }
}

// Auto-hide toast notifications
document.addEventListener('DOMContentLoaded', function() {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => {
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    });
});
</script>
{% endblock %}
